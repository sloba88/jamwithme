{% extends 'JamWebBundle::layoutNoSidebar.html.twig' %}

{% block main_content %}

    <div class="row messages-header">
        <div class="col-xs-12">
            <h1 class="title">Messages</h1>
            <a href="#" class="btn btn-compose">+ Compose new message</a>
        </div>
    </div><!--messages-header ends-->

    <div class="row messages-container">
        <div class="col-xs-12 conversations-box"></div>
    </div><!--messages-container ends-->

    <script type="text/template" id="conversationTemplate">
        <% _.each( rc, function( c, k ){ %>
        <div class="row message-single conversation-box <% if (k == 0 ){ %>first<% } %>" data-user="<%- c.username %>" data-id="<%- c.id %>">
            <div class="col-xs-4 col-sm-3 message-info">
                <img class="message-picture" src="{{ app.request.getBaseURL() }}/m/<%- c.username %>/avatar" alt="Pic">

                <h3 class="name"><%- c.username %></h3>

                <div class="time">
                    05 Nov 2014
                </div>
            </div>
            <div class="col-xs-8 col-sm-9 message-content">
                <p>
                    Going from Nirvana to any other band is a really tough thing to do. For decades visual artists have been creating art for record covers.
                </p>
                <i class="fa fa-angle-right"></i>
            </div>
        </div><!--message-one ends-->
        <% }); %>
    </script>

{% endblock %}

{% block javascripts %}

    <script>

        var myID = {{ app.user.id }};

        jQuery(document).ready(function () {

            setTimeout(function () {
                socket.emit('getMyMessages', {userID: 'myID'});
            }, 500);

            _.templateSettings.variable = "rc";
            var messageTemplate = _.template($("#messageTemplate").html());
            var conversationTemplate = _.template($("#conversationTemplate").html());
            var conversations = [];

            socket.on('myMessages', function (data) {

                $.each(data, function (index, value) {
                    $(".conversation-message-box").append(messageTemplate(value));

                    $.each(value.messages, function (index, val) {
                        var other;
                        if (val.to.id == myID) {
                            other = val.from;
                        } else {
                            other = val.to;
                        }
                        if (!_.findWhere(conversations, other)) {
                            conversations.push(other);
                        }
                    });
                });

                $(".conversations-box").append(conversationTemplate(conversations));
                scrollToBottom();
            });
        });
    </script>

{% endblock %}