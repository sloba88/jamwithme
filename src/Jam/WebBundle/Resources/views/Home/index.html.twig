{% extends 'JamWebBundle::layout.html.twig' %}

{% block bodyclasses %}page-dashboard{% endblock %}

{% block bodystyle %}background-image: url({{ asset('assets/images/background-dashboard.jpg') }}){% endblock %}

{% block main_content %}


    <div class="row event" style="display:none">

        <div class="col-lg-5 image-box">
            <div class="image-holder">
                <img src="{{ asset('assets/images/events-picture-01.png') }}" alt="Event">
            </div>
            <div class="promo">
                <h4>upcoming event</h4>
                <a href="#" class="link">view all<i class="glyphicon glyphicon-play"></i></a>
            </div>
        </div>

        <div class="col-lg-7 text-box">
            <div class="time">05 Sep 2014
                <a href="#" class="view-details link">view details</a>
            </div>
            <h3>Kompakt at Oz. Amsterdam KOMPAKT Pop Up store</h3>
            <p>
                14:00 - 20:00 | Free entrance<br>
                Oz. | Oudezijds Achterburgwal 66, Amsterdam
            </p>
        </div>

    </div><!--event ends-->

    {% include "JamWebBundle::Musicians/filter.html.twig" %}

{% endblock %}

{% block right_sidebar_content %}

        {% if is_granted("ROLE_USER") and app.user.profileFulfilment != 100 %}
            <div class="profile-completion clearfix">
                <div class="pick">
                    <div class="pick-outer">
                        <img src="{{ asset('assets/images/pick-outer.png') }}" alt="Profile completion">
                    </div>
                    <span class="pick-inner"></span>
                </div>
                    <div class="profile-completion-text">
                        <h3><span>{{ app.user.profileFulfilment }}%</span>profile completion</h3>
                        <a href="{{ path('fos_user_profile_edit') }}" class="link">fill out your profile</a>
                    </div>
            </div><!--profile-completion ends-->
        {% endif %}


    <div class="shouts-feed">
        <h3>Shouts feed</h3>
        <form role="form" action="{{ path('home') }}" method="POST">
            {{ form_widget(form.text, {'attr': {'class': 'form-control', 'placeholder': 'Shout', 'rows': '3'}}) }}
            {{ form_widget(form.send, {'attr': {'class': 'btn btn-primary'}}) }}
            {{ form_widget(form._token) }}
        </form>
    </div><!--shouts-feed ends-->

    <div class="shouts-listing-container">
        <h4 class="shouts">Shouts</h4>
        <div class="shouts-listing shouts-listing-filter with-scrollbar"></div><!--shouts-listing ends-->
    </div><!--shouts-listing-container ends-->

{% endblock %}

{% block bottom_javascripts %}

<script>

    $.ajax({
        url: baseURL+'/shouts/find'
        //data: data
    }).done(function( result ) {
        if (result.status == 'success'){
            $.each(result.data, function(k, v){
                $( ".shouts-listing" ).prepend(shoutBoxTemplate( v ) );
            });
        }
    });

    var map;
    var $map = $('#map-canvas');
    var distanceCircle;
    var bounds = null;
    var donut;
    var iconBase = 'https://maps.google.com/mapfiles/kml/';

    function initializeMap() {

        var mapOptions = {
            zoom: 12,
            maxZoom: 13,
            scrollwheel: false,
            zoomControl: true,
            zoomControlOptions: {
                style: google.maps.ZoomControlStyle.SMALL,
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            }
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        bounds = new google.maps.LatLngBounds();

        if ($map.data('lat') == ''){
            getLocation();
        }else{
            map.setCenter(new google.maps.LatLng(parseFloat($map.data('lat')), parseFloat($map.data('lng'))));
        }

        drawRadius($("#search_form_distance").val());

        renderMapView();

    }

    function getLocation(){
        if (navigator.geolocation){
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        }else{
            alert("Geolocation is not supported by this browser.");
        }
    }
    function showPosition(position){
        map.setCenter(new google.maps.LatLng(parseFloat(position.coords.latitude), position.coords.longitude));
        $map.data('lat', position.coords.latitude);
        $map.data('lng', position.coords.longitude);
        addMyselfOnMap(map);
        //save to database also
    }

    function showError(error) {
        switch(error.code)
        {
            case error.PERMISSION_DENIED:
                alert("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                alert("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                alert("An unknown error occurred.");
                break;
        }
    }

    function drawRadius(radius){
        if (typeof donut != 'undefined') donut.setMap(null);

        donut = new google.maps.Polygon({
            paths: [drawCircle(new google.maps.LatLng(parseFloat($map.data('lat')), parseFloat($map.data('lng'))), 1000, 1),
                drawCircle(new google.maps.LatLng(parseFloat($map.data('lat')), parseFloat($map.data('lng'))), radius, -1)],
            strokeColor: "white",
            strokeOpacity: 0.8,
            strokeWeight: 5,
            map: map,
            fillColor: "blue",
            fillOpacity: 0.10
        });
    }

    function addMyselfOnMap(map){
        icon = iconBase + 'pal2/icon2.png';
        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(parseFloat($map.data('lat')), parseFloat($map.data('lng'))),
            map: map,
            title: '{{ app.user.username }}',
            icon: icon
        });
        markers.push(marker);
    }

    var delay = (function(){
        var timer = 0;
        return function(callback, ms){
            clearTimeout (timer);
            timer = setTimeout(callback, ms);
        };
    })();

    $(function() {

        $('#map-view').on('click', function(){
            delay(function(){
                initializeMap();
            }, 500);
        });

        if (localStorage.view=="list") {
            $("#list-tab-btn").click();
        }

        $("#main-filter-form").on('change', function(){
            delay(function(){
                if ($('#map-canvas').is(':visible')){
                    fetchMapData();
                }else{
                    filterMusicians();
                }

            }, 500);
        });

        filterMusicians();

        //parse generes
        $.ajax({
            url: Routing.generate('api_genres')
        }).done(function( result ) {
            $.each(result, function(k, v){
                $('#filter-genres').append('<option value="'+v.id+'">'+ v.name + '</option>');
            });

            //parse instruments
            $.ajax({
                url: Routing.generate('api_instruments')
            }).done(function( result ) {
                $.each(result, function(k, v){
                    $('#filter-instruments').append('<option value="'+v.id+'">'+ v.name + '</option>');
                });

                $('select').select2();
            });
        });

        //activate tabs
        tabsToggle($('.tabs-activate'));

        //activates tooltip
        $("[data-toggle=tooltip]").tooltip();

        $('body').on('click', '#subscribeToSearch', function(e){
            e.preventDefault();
            var data = {};
            data.genres = [];
            data.instruments = [];

            $('#filter-genres option:selected').each(function () {
                if ($(this).length) {
                    data.genres.push($(this).text())
                }
            });

            $('#filter-instruments option:selected').each(function () {
                if ($(this).length) {
                    data.instruments.push($(this).text())
                }
            });

            data.distance = $('#search_form_distance').val();
            data.isTeacher = $('#lessons-checkbox').val();

            $.ajax({
                url: Routing.generate('subscribe_search_add'),
                data: $.param(data)
            }).done(function( result ) {
                if (result.status == 'success') {
                    $('.people-listing-grid').html(notificationTemplate({ type : 'success', message : 'Subscription to this search made successfully', temp : 'temp' }));
                }
            });
        });

    });

    var markers = [];
    var filterResults;

    function filterMusicians(){
        var data='';

        if ( $("#filter-genres").val() != 0 ){
            data += $("#filter-genres").serialize();
        }

        if ( $("#filter-instruments").val() != 0 ){
            data += $("#filter-instruments").serialize();
        }

        if ($("#lessons-checkbox").is(':checked')) {
            data += '&isTeacher=1';
        }

        if ( $("#search_form_distance").val() != 0 ){
            data += '&'+ $("#search_form_distance").serialize();
        }

        var url = $map.data('url');

        $.ajax({
            url: url,
            data: data
        }).done(function( result ) {
            if (result.status == 'success') {
                filterResults = result;
                renderGridView();
                if (result.data.length == 0){
                    $('.people-listing-grid').html('<br /><p>Didn\'t find what you searched for? We can let you know when people with this profile join. <br /><a href="#" id="subscribeToSearch">Subscribe for this search criteria.</a></p>')
                }
            }
        });
    }

    function renderGridView() {
        $(".people-listing-grid").html('');
        $.each(filterResults.data, function (k, v) {
            $(".people-listing-grid").append(musicianBoxTemplate(v));
        });
    }

    function renderMapView() {
        var infowindow = null;
        deleteMarkers();
        drawRadius($("#search_form_distance").val());
        $.each(filterResults.data, function (k, v) {
            icon = iconBase + 'pal4/icon39.png';

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(v.lat, v.lng),
                map: map,
                title: v.username,
                icon: icon
            });
            markers.push(marker);

            google.maps.event.addListener(marker, 'mouseover', function() {
                if (infowindow) {
                    infowindow.close();
                }

                infowindow = new google.maps.InfoWindow({
                    content: musicianMapBoxTemplate( v )
                });

                infowindow.open(map,marker);
            });
        });

        addMyselfOnMap(map);

        // Sets the map on all markers in the array.
        function setAllMap(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setAllMap(null);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }
    }

    function fetchMapData(){
        var data='';

        if ( $("#filter-genres").val() != 0 ){
            data += $("#filter-genres").serialize();
        }

        if ( $("#filter-instruments").val() != 0 ){
            data += $("#filter-instruments").serialize();
        }

        if ($("#lessons-checkbox").is(':checked')) {
            data += '&isTeacher=1';
        }

        var url = $map.data('url');
        var infowindow = null;
        $( ".people-listing-grid").html('');
        $.ajax({
            url: url,
            data: data
        }).done(function( result ) {
            if (result.status == 'success'){
                deleteMarkers();
                drawRadius($("#search_form_distance").val());
                $.each(result.data, function(k, v){

                    $( ".people-listing-grid" ).append(musicianBoxTemplate( v ) );

                    icon = iconBase + 'pal4/icon39.png';

                    var marker = new google.maps.Marker({
                        position: new google.maps.LatLng(v.lat, v.lng),
                        map: map,
                        title: v.username,
                        icon: icon
                    });
                    markers.push(marker);

                    google.maps.event.addListener(marker, 'mouseover', function() {
                        if (infowindow) {
                            infowindow.close();
                        }

                        infowindow = new google.maps.InfoWindow({
                            content: musicianMapBoxTemplate( v )
                        });

                        infowindow.open(map,marker);
                    });

                });

                $(".list-view-container > div ").addClass('col-md-4');

                //add myself on map
                addMyselfOnMap(map);
            }else{
                alert('Please set your location to be able to see people around you');
            }
        });

        // Sets the map on all markers in the array.
        function setAllMap(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setAllMap(null);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }
    }

    function drawCircle(point, radius, dir) {
        var d2r = Math.PI / 180;   // degrees to radians
        var r2d = 180 / Math.PI;   // radians to degrees
        var earthsradius = 6371; // 3963 is the radius of the earth in miles

        var points = 128;

        // find the raidus in lat/lon
        var rlat = (radius / earthsradius) * r2d;
        var rlng = rlat / Math.cos(point.lat() * d2r);


        var extp = new Array();
        if (dir==1)	{var start=0;var end=points+1} // one extra here makes sure we connect the
        else		{var start=points+1;var end=0}
        for (var i=start; (dir==1 ? i < end : i > end); i=i+dir)
        {
            var theta = Math.PI * (i / (points/2));
            ey = point.lng() + (rlng * Math.cos(theta)); // center a + radius x * cos(theta)
            ex = point.lat() + (rlat * Math.sin(theta)); // center b + radius y * sin(theta)
            extp.push(new google.maps.LatLng(ex, ey));
            bounds.extend(extp[extp.length-1]);
        }
        // alert(extp.length);
        return extp;
    }

</script>

{% endblock %}
