services:
    fos_user.doctrine_registry:
        alias: doctrine

    shout.counter:
        class: Jam\CoreBundle\Services\ShoutCounter
        calls:
            - [setEntityManager, ["@doctrine.orm.entity_manager"]]
            - [setTokenStorage, ["@security.token_storage"]]
            - [setShout]

    search.musicians:
        class: Jam\CoreBundle\Services\SearchMusicians
        calls:
            - [setElasticUserFinder, ["@fos_elastica.finder.searches.compatibility"]]
            - [setTokenStorage, ["@security.token_storage"]]
            - [setTracker, ["@happyr.google.analytics.tracker"]]

    search.subscriber.cron:
        class: Jam\CoreBundle\Services\SearchSubscriberCron
        calls:
            - [setEntityManager, ["@doctrine.orm.entity_manager"]]
            - [setTwig, ["@templating"]]
            - [setMailer, ["@mailer"]]
            - [setLogger, ["@logger"]]
            - [checkMailParams, [%mailer_user%, %mailer_password%]]
            - [setMusiciansSearch, ["@search.musicians"]]

    compatibility.calculator:
            class: Jam\CoreBundle\Services\CompatibilityCalculator
            calls:
                - [setEntityManager, ["@doctrine.orm.entity_manager"]]
                - [setTokenStorage, ["@security.token_storage"]]
                - [setElasticaUsersFinder, ["@fos_elastica.finder.searches.user"]]
                - [setElasticaCompatibilityIndex, ["@fos_elastica.index.searches.compatibility"]]
            tags:
                -  { name: kernel.event_listener, event: security.interactive_login, method: calculate }
                -  { name: kernel.event_listener, event: fos_user.profile.edit.success, method: calculate }
                -  { name: kernel.event_listener, event: fos_user.registration.confirmed, method: calculate }
